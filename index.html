<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ModernMUD i18n Editor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .main {
      padding: 30px;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }

    .form-group small {
      display: block;
      margin-top: 5px;
      color: #666;
      font-size: 12px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .list {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    .list-item {
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .list-item:hover {
      background: #f5f5f5;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item.selected {
      background: #e8eaf6;
      color: #667eea;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .info-box {
      background: #e8f4f8;
      border-left: 4px solid #2196F3;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .info-box p {
      color: #1976D2;
      font-size: 14px;
      line-height: 1.5;
    }

    .progress {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 12px;
      color: #999;
      font-weight: 600;
    }

    .progress-step.active {
      background: #667eea;
      color: white;
    }

    .progress-step.completed {
      background: #48bb78;
      color: white;
    }

    .card {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .card h3 {
      color: #667eea;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .card p {
      color: #666;
      font-size: 13px;
    }

    .preview {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 300px;
      overflow-y: auto;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .toolbar button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toolbar .btn-export {
      background: #48bb78;
      color: white;
    }

    .toolbar .btn-import {
      background: #2196F3;
      color: white;
    }

    .toolbar .btn-lang {
      background: #FF9800;
      color: white;
    }

    input[type="file"] {
      display: none;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* Tree View Styles */
    .tree-view {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
    }

    .tree-item {
      margin-bottom: 8px;
    }

    .tree-node {
      padding: 10px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tree-node:hover {
      border-color: #667eea;
      background: #f5f7ff;
    }

    .tree-node-header {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .tree-node-icon {
      font-size: 16px;
    }

    .tree-node-label {
      font-weight: 600;
      color: #333;
    }

    .tree-node-count {
      font-size: 12px;
      color: #666;
      background: #e8e8e8;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .tree-children {
      margin-left: 30px;
      margin-top: 8px;
      display: none;
    }

    .tree-children.expanded {
      display: block;
    }

    .tree-toggle {
      padding: 4px 8px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tree-toggle:hover {
      background: #5568d3;
    }

    .tree-leaf {
      padding: 8px 12px;
      background: #f0f0f0;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin-bottom: 6px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tree-leaf-key {
      font-family: 'Courier New', monospace;
      color: #667eea;
      font-weight: 600;
    }

    .tree-leaf-value {
      color: #666;
      font-size: 12px;
      max-width: 400px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .search-box input:focus {
      outline: none;
      border-color: #667eea;
    }

    .expand-all-btn {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üåç ModernMUD i18n Editor</h1>
      <p>Crea y edita traducciones de forma f√°cil e intuitiva</p>
    </div>

    <div class="main">
      <!-- Toolbar -->
      <div class="toolbar">
        <select id="languageSelect">
          <option value="">Selecciona idioma</option>
        </select>
        <button class="btn-export" onclick="app.exportAll()">üíæ Exportar Todo</button>
        <button class="btn-lang" onclick="app.showNewLanguageModal()">‚ûï Nuevo Idioma</button>
      </div>

      <!-- Progress -->
      <div class="progress">
        <div class="progress-step" id="progress-1">1. Idioma</div>
        <div class="progress-step" id="progress-2">2. Archivo</div>
        <div class="progress-step" id="progress-3">3. Tipo</div>
        <div class="progress-step" id="progress-4">4. Crear/Editar</div>
      </div>

      <!-- Step 1: Select Language -->
      <div class="step active" id="step1">
        <h2 style="margin-bottom: 20px; color: #333;">Selecciona un Idioma</h2>
        <div id="languageList" class="list"></div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="app.showNewLanguageModal()">‚ûï Crear Nuevo Idioma</button>
        </div>
      </div>

      <!-- Step 2: Select File -->
      <div class="step" id="step2">
        <h2 style="margin-bottom: 20px; color: #333;">Selecciona un Archivo</h2>
        <div id="fileList" class="list"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="app.goToStep(1)">‚Üê Atr√°s</button>
        </div>
      </div>

      <!-- Step 3: Select Type -->
      <div class="step" id="step3">
        <h2 style="margin-bottom: 20px; color: #333;">¬øQu√© deseas hacer?</h2>

        <div class="card" onclick="app.selectAction('view')">
          <h3>üëÅÔ∏è Ver Contenido</h3>
          <p>Explorar y ver todo el contenido del archivo</p>
        </div>

        <div class="card" onclick="app.selectAction('create')">
          <h3>‚ú® Crear Nueva Entrada</h3>
          <p>A√±adir una nueva isla, zona, habitaci√≥n, item, NPC, etc.</p>
        </div>

        <div class="card" onclick="app.selectAction('edit')">
          <h3>‚úèÔ∏è Editar Existente</h3>
          <p>Modificar una entrada que ya existe</p>
        </div>

        <div class="card" onclick="app.selectAction('delete')">
          <h3>üóëÔ∏è Eliminar Entrada</h3>
          <p>Borrar una entrada existente</p>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="app.goToStep(2)">‚Üê Atr√°s</button>
        </div>
      </div>

      <!-- Step 4: Form -->
      <div class="step" id="step4">
        <h2 style="margin-bottom: 20px; color: #333;" id="step4Title">Crear Nueva Entrada</h2>
        <div id="formContainer"></div>
      </div>
    </div>
  </div>

  <script>
    const app = {
      data: {},
      currentLang: null,
      currentFile: null,
      currentStep: 1,
      currentAction: null,

      init() {
        this.loadFromCache();
        this.loadLanguages();
        this.renderLanguageSelect();
        this.renderLanguageList();
        this.setupAutoSave();
      },

      loadFromCache() {
        const cached = localStorage.getItem('i18n-data');
        if (cached) {
          this.data = JSON.parse(cached);
        }
      },

      saveToCache() {
        localStorage.setItem('i18n-data', JSON.stringify(this.data));
      },

      setupAutoSave() {
        setInterval(() => this.saveToCache(), 2000);
      },

      async loadLanguages() {
        const languages = ['es', 'en'];
        const files = ['commands', 'enemies', 'items', 'map', 'messages', 'npcs', 'ui'];

        for (const lang of languages) {
          if (!this.data[lang]) this.data[lang] = {};

          for (const file of files) {
            try {
              const response = await fetch(`public/i18n/${lang}/${file}.json`);
              if (response.ok) {
                this.data[lang][file] = await response.json();
              }
            } catch (error) {
              console.warn(`No se pudo cargar ${lang}/${file}.json`);
              if (!this.data[lang][file]) this.data[lang][file] = {};
            }
          }
        }

        this.saveToCache();
        this.renderLanguageSelect();
        this.renderLanguageList();
      },

      renderLanguageSelect() {
        const select = document.getElementById('languageSelect');
        select.innerHTML = '<option value="">Selecciona idioma</option>';

        Object.keys(this.data).forEach(lang => {
          const option = document.createElement('option');
          option.value = lang;
          option.textContent = lang.toUpperCase();
          select.appendChild(option);
        });

        select.onchange = (e) => {
          this.currentLang = e.target.value;
          if (this.currentLang) {
            this.goToStep(2);
          }
        };
      },

      renderLanguageList() {
        const list = document.getElementById('languageList');
        list.innerHTML = '';

        Object.keys(this.data).forEach(lang => {
          const item = document.createElement('div');
          item.className = 'list-item';
          item.innerHTML = `
            <span>${lang.toUpperCase()}</span>
            <span class="badge">Idioma</span>
          `;
          item.onclick = () => {
            this.currentLang = lang;
            document.getElementById('languageSelect').value = lang;
            this.goToStep(2);
          };
          list.appendChild(item);
        });
      },

      goToStep(step) {
        // Hide all steps
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));

        // Show current step
        document.getElementById(`step${step}`).classList.add('active');

        // Update progress
        for (let i = 1; i <= 4; i++) {
          const progressStep = document.getElementById(`progress-${i}`);
          progressStep.classList.remove('active', 'completed');
          if (i < step) progressStep.classList.add('completed');
          if (i === step) progressStep.classList.add('active');
        }

        this.currentStep = step;

        // Render step content
        if (step === 2) this.renderFileList();
      },

      renderFileList() {
        const list = document.getElementById('fileList');
        list.innerHTML = '';

        if (!this.currentLang || !this.data[this.currentLang]) return;

        const fileInfo = {
          'map': { icon: 'üó∫Ô∏è', desc: 'Islas, zonas y habitaciones' },
          'items': { icon: 'üéí', desc: 'Items y objetos del juego' },
          'enemies': { icon: '‚öîÔ∏è', desc: 'Enemigos y criaturas' },
          'npcs': { icon: 'üí¨', desc: 'NPCs y personajes' },
          'commands': { icon: 'üéÆ', desc: 'Comandos del juego' },
          'messages': { icon: 'üìù', desc: 'Mensajes del sistema' },
          'ui': { icon: 'üñ•Ô∏è', desc: 'Interfaz de usuario' }
        };

        Object.keys(this.data[this.currentLang]).forEach(file => {
          const info = fileInfo[file] || { icon: 'üìÑ', desc: 'Archivo de traducci√≥n' };
          const item = document.createElement('div');
          item.className = 'list-item';
          item.innerHTML = `
            <span>${info.icon} ${file}.json</span>
            <span class="badge">${info.desc}</span>
          `;
          item.onclick = () => {
            this.currentFile = file;
            this.goToStep(3);
          };
          list.appendChild(item);
        });
      },

      selectAction(action) {
        this.currentAction = action;
        this.goToStep(4);

        if (action === 'view') {
          this.showViewContent();
        } else if (action === 'create') {
          this.showCreateForm();
        } else if (action === 'edit') {
          this.showEditForm();
        } else if (action === 'delete') {
          this.showDeleteForm();
        }
      },

      showViewContent() {
        document.getElementById('step4Title').textContent = 'Ver Contenido del Archivo';
        const container = document.getElementById('formContainer');
        const data = this.data[this.currentLang][this.currentFile];

        container.innerHTML = `
          <div class="info-box">
            <p><strong>Archivo:</strong> ${this.currentFile}.json - Explora todo el contenido de este archivo</p>
          </div>

          <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Buscar en el contenido..." onkeyup="app.filterTree()">
          </div>

          <div class="expand-all-btn">
            <button class="btn btn-secondary" onclick="app.expandAll()">üìÇ Expandir Todo</button>
            <button class="btn btn-secondary" onclick="app.collapseAll()">üìÅ Colapsar Todo</button>
          </div>

          <div class="tree-view" id="treeView"></div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="app.goToStep(3)">‚Üê Atr√°s</button>
          </div>
        `;

        this.renderTree(data, 'treeView');
      },

      renderTree(data, containerId, parentPath = '') {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        this.buildTree(data, container, parentPath);
      },

      buildTree(obj, container, path = '', level = 0) {
        if (!obj || typeof obj !== 'object') return;

        Object.entries(obj).forEach(([key, value]) => {
          const currentPath = path ? `${path}.${key}` : key;
          const itemDiv = document.createElement('div');
          itemDiv.className = 'tree-item';
          itemDiv.dataset.path = currentPath;

          if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
            const childCount = Object.keys(value).length;
            const icon = this.getIconForKey(key);

            itemDiv.innerHTML = `
              <div class="tree-node" onclick="app.toggleNode('${currentPath}')">
                <div class="tree-node-header">
                  <span class="tree-node-icon">${icon}</span>
                  <span class="tree-node-label">${key}</span>
                  <span class="tree-node-count">${childCount} items</span>
                </div>
                <button class="tree-toggle" onclick="event.stopPropagation(); app.toggleNode('${currentPath}')">‚ñº</button>
              </div>
              <div class="tree-children" id="children-${currentPath.replace(/\./g, '-')}"></div>
            `;

            container.appendChild(itemDiv);
            const childrenContainer = itemDiv.querySelector('.tree-children');
            this.buildTree(value, childrenContainer, currentPath, level + 1);

          } else {
            let displayValue = value;
            if (typeof value === 'string' && value.length > 100) {
              displayValue = value.substring(0, 100) + '...';
            } else if (Array.isArray(value)) {
              displayValue = `[${value.length} items]`;
            }

            itemDiv.innerHTML = `
              <div class="tree-leaf">
                <span class="tree-leaf-key">${key}</span>
                <span class="tree-leaf-value">${this.escapeHtml(String(displayValue))}</span>
              </div>
            `;

            container.appendChild(itemDiv);
          }
        });
      },

      getIconForKey(key) {
        const iconMap = {
          'islands': 'üèùÔ∏è',
          'zones': 'üå≤',
          'rooms': 'üö™',
          'name': 'üìù',
          'description': 'üìÑ',
          'dialogues': 'üí¨',
          'commands': 'üéÆ',
          'enemies': '‚öîÔ∏è',
          'items': 'üéí',
          'npcs': 'üë§',
          'messages': '‚úâÔ∏è',
          'ui': 'üñ•Ô∏è'
        };
        return iconMap[key] || 'üìã';
      },

      toggleNode(path) {
        const safePath = path.replace(/\./g, '-');
        const childrenEl = document.getElementById(`children-${safePath}`);
        const toggleBtn = event.target.closest('.tree-node')?.querySelector('.tree-toggle');

        if (childrenEl) {
          childrenEl.classList.toggle('expanded');
          if (toggleBtn) {
            toggleBtn.textContent = childrenEl.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
          }
        }
      },

      expandAll() {
        document.querySelectorAll('.tree-children').forEach(el => {
          el.classList.add('expanded');
        });
        document.querySelectorAll('.tree-toggle').forEach(btn => {
          btn.textContent = '‚ñ≤';
        });
      },

      collapseAll() {
        document.querySelectorAll('.tree-children').forEach(el => {
          el.classList.remove('expanded');
        });
        document.querySelectorAll('.tree-toggle').forEach(btn => {
          btn.textContent = '‚ñº';
        });
      },

      filterTree() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.tree-item');

        items.forEach(item => {
          const path = item.dataset.path.toLowerCase();
          const text = item.textContent.toLowerCase();

          if (searchTerm === '' || path.includes(searchTerm) || text.includes(searchTerm)) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      },

      showCreateForm() {
        document.getElementById('step4Title').textContent = 'Crear Nueva Entrada';
        const container = document.getElementById('formContainer');

        if (this.currentFile === 'map') {
          container.innerHTML = this.getMapForm();
        } else if (this.currentFile === 'items') {
          container.innerHTML = this.getItemForm();
        } else if (this.currentFile === 'enemies') {
          container.innerHTML = this.getEnemyForm();
        } else if (this.currentFile === 'npcs') {
          container.innerHTML = this.getNPCForm();
        } else {
          container.innerHTML = this.getGenericForm();
        }
      },

      getMapForm() {
        const data = this.data[this.currentLang][this.currentFile];
        const islands = data.islands ? Object.keys(data.islands) : [];

        return `
          <div class="info-box">
            <p><strong>Mapa:</strong> Crea islas, zonas y habitaciones de forma sencilla.</p>
          </div>

          <div class="form-group">
            <label>¬øQu√© deseas crear?</label>
            <select id="mapType" onchange="app.updateMapForm()">
              <option value="">Selecciona...</option>
              <option value="island">üèùÔ∏è Nueva Isla</option>
              <option value="zone">üå≤ Nueva Zona (en una isla existente)</option>
              <option value="room">üö™ Nueva Habitaci√≥n (en una zona existente)</option>
            </select>
          </div>

          <div id="mapFormContent"></div>
        `;
      },

      updateMapForm() {
        const type = document.getElementById('mapType').value;
        const container = document.getElementById('mapFormContent');
        const data = this.data[this.currentLang][this.currentFile];

        if (type === 'island') {
          container.innerHTML = `
            <div class="form-group">
              <label>ID de la isla (sin espacios, ej: shadow_island)</label>
              <input type="text" id="islandId" placeholder="shadow_island">
              <small>Este es el identificador √∫nico de la isla</small>
            </div>

            <div class="form-group">
              <label>Nombre de la isla</label>
              <input type="text" id="islandName" placeholder="Isla de las Sombras">
              <small>El nombre que ver√°n los jugadores</small>
            </div>

            <div class="btn-group">
              <button class="btn btn-secondary" onclick="app.goToStep(3)">‚Üê Atr√°s</button>
              <button class="btn btn-primary" onclick="app.saveIsland()">‚úÖ Crear Isla</button>
            </div>
          `;
        } else if (type === 'zone') {
          const islands = data.islands ? Object.keys(data.islands) : [];
          const islandOptions = islands.map(id => `<option value="${id}">${data.islands[id].name || id}</option>`).join('');

          container.innerHTML = `
            <div class="form-group">
              <label>¬øEn qu√© isla?</label>
              <select id="zoneIsland">
                <option value="">Selecciona una isla...</option>
                ${islandOptions}
              </select>
            </div>

            <div class="form-group">
              <label>ID de la zona (sin espacios, ej: dark_forest)</label>
              <input type="text" id="zoneId" placeholder="dark_forest">
            </div>

            <div class="form-group">
              <label>Nombre de la zona</label>
              <input type="text" id="zoneName" placeholder="Bosque Oscuro">
            </div>

            <div class="btn-group">
              <button class="btn btn-secondary" onclick="app.goToStep(3)">‚Üê Atr√°s</button>
              <button class="btn btn-primary" onclick="app.saveZone()">‚úÖ Crear Zona</button>
            </div>
          `;
        } else if (type === 'room') {
          const islands = data.islands ? Object.keys(data.islands) : [];
          const islandOptions = islands.map(id => `<option value="${id}">${data.islands[id].name || id}</option>`).join('');

          container.innerHTML = `
            <div class="form-group">
              <label>¬øEn qu√© isla?</label>
              <select id="roomIsland" onchange="app.updateZoneList()">
                <option value="">Selecciona una isla...</option>
                ${islandOptions}
              </select>
            </div>

            <div class="form-group">
              <label>¬øEn qu√© zona?</label>
              <select id="roomZone">
                <option value="">Primero selecciona una isla</option>
              </select>
            </div>

            <div class="form-group">
              <label>ID de la habitaci√≥n (sin espacios, ej: entrance_hall)</label>
              <input type="text" id="roomId" placeholder="entrance_hall">
            </div>

            <div class="form-group">
              <label>Nombre de la habitaci√≥n</label>
              <input type="text" id="roomName" placeholder="Entrada del Templo">
            </div>

            <div class="form-group">
              <label>Descripci√≥n de la habitaci√≥n</label>
              <textarea id="roomDescription" rows="6" placeholder="Una gran entrada con columnas de m√°rmol y antorchas..."></textarea>
              <small>Puedes usar colores como [color=#FF0000]texto[/color]</small>
            </div>

            <div class="btn-group">
              <button class="btn btn-secondary" onclick="app.goToStep(3)">‚Üê Atr√°s</button>
              <button class="btn btn-primary" onclick="app.saveRoom()">‚úÖ Crear Habitaci√≥n</button>
            </div>
          `;
        }
      },

      updateZoneList() {
        const islandId = document.getElementById('roomIsland').value;
        const zoneSelect = document.getElementById('roomZone');
        const data = this.data[this.currentLang][this.currentFile];

        if (!islandId || !data.islands || !data.islands[islandId] || !data.islands[islandId].zones) {
          zoneSelect.innerHTML = '<option value="">No hay zonas en esta isla</option>';
          return;
        }

        const zones = Object.keys(data.islands[islandId].zones);
        zoneSelect.innerHTML = '<option value="">Selecciona una zona...</option>' +
          zones.map(id => `<option value="${id}">${data.islands[islandId].zones[id].name || id}</option>`).join('');
      },

      saveIsland() {
        const id = document.getElementById('islandId').value.trim();
        const name = document.getElementById('islandName').value.trim();

        if (!id || !name) {
          alert('Por favor completa todos los campos');
          return;
        }

        const data = this.data[this.currentLang][this.currentFile];
        if (!data.islands) data.islands = {};

        data.islands[id] = {
          name: name,
          zones: {}
        };

        this.saveToCache();
        alert(`‚úÖ Isla "${name}" creada correctamente`);
        this.goToStep(1);
      },

      saveZone() {
        const islandId = document.getElementById('zoneIsland').value;
        const zoneId = document.getElementById('zoneId').value.trim();
        const zoneName = document.getElementById('zoneName').value.trim();

        if (!islandId || !zoneId || !zoneName) {
          alert('Por favor completa todos los campos');
          return;
        }

        const data = this.data[this.currentLang][this.currentFile];
        if (!data.islands[islandId].zones) data.islands[islandId].zones = {};

        data.islands[islandId].zones[zoneId] = {
          name: zoneName,
          rooms: {}
        };

        this.saveToCache();
        alert(`‚úÖ Zona "${zoneName}" creada en la isla`);
        this.goToStep(1);
      },

      saveRoom() {
        const islandId = document.getElementById('roomIsland').value;
        const zoneId = document.getElementById('roomZone').value;
        const roomId = document.getElementById('roomId').value.trim();
        const roomName = document.getElementById('roomName').value.trim();
        const roomDescription = document.getElementById('roomDescription').value.trim();

        if (!islandId || !zoneId || !roomId || !roomName || !roomDescription) {
          alert('Por favor completa todos los campos');
          return;
        }

        const data = this.data[this.currentLang][this.currentFile];
        if (!data.islands[islandId].zones[zoneId].rooms) {
          data.islands[islandId].zones[zoneId].rooms = {};
        }

        data.islands[islandId].zones[zoneId].rooms[roomId] = {
          name: roomName,
          description: roomDescription
        };

        this.saveToCache();
        alert(`‚úÖ Habitaci√≥n "${roomName}" creada correctamente`);
        this.goToStep(1);
      },

      getItemForm() {
        return `
          <div class="info-box">
            <p><strong>Items:</strong> Crea un nuevo objeto para el juego.</p>
          </div>

          <div class="form-group">
            <label>ID del item (sin espacios, ej: magic_sword)</label>
            <input type="text" id="itemId" placeholder="magic_sword">
          </div>

          <div class="form-group">
            <label>Nombre del item</label>
            <input type="text" id="itemName" placeholder="Espada M√°gica">
          </div>

          <div class="form-group">
            <label>Descripci√≥n</label>
            <textarea id="itemDescription" rows="4" placeholder="Una espada brillante con runas m√≠sticas..."></textarea>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="app.goToStep(3)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" onclick="app.saveItem()">‚úÖ Crear Item</button>
          </div>
        `;
      },

      saveItem() {
        const id = document.getElementById('itemId').value.trim();
        const name = document.getElementById('itemName').value.trim();
        const description = document.getElementById('itemDescription').value.trim();

        if (!id || !name || !description) {
          alert('Por favor completa todos los campos');
          return;
        }

        const data = this.data[this.currentLang][this.currentFile];
        data[id] = { name, description };

        this.saveToCache();
        alert(`‚úÖ Item "${name}" creado correctamente`);
        this.goToStep(1);
      },

      getEnemyForm() {
        return `
          <div class="info-box">
            <p><strong>Enemigos:</strong> Crea un nuevo enemigo o criatura.</p>
          </div>

          <div class="form-group">
            <label>ID del enemigo (sin espacios, ej: fire_dragon)</label>
            <input type="text" id="enemyId" placeholder="fire_dragon">
          </div>

          <div class="form-group">
            <label>Nombre del enemigo</label>
            <input type="text" id="enemyName" placeholder="Drag√≥n de Fuego">
          </div>

          <div class="form-group">
            <label>Descripci√≥n</label>
            <textarea id="enemyDescription" rows="4" placeholder="Un drag√≥n enorme con escamas rojas..."></textarea>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="app.goToStep(3)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" onclick="app.saveEnemy()">‚úÖ Crear Enemigo</button>
          </div>
        `;
      },

      saveEnemy() {
        const id = document.getElementById('enemyId').value.trim();
        const name = document.getElementById('enemyName').value.trim();
        const description = document.getElementById('enemyDescription').value.trim();

        if (!id || !name || !description) {
          alert('Por favor completa todos los campos');
          return;
        }

        const data = this.data[this.currentLang][this.currentFile];
        data[id] = { name, description };

        this.saveToCache();
        alert(`‚úÖ Enemigo "${name}" creado correctamente`);
        this.goToStep(1);
      },

      getNPCForm() {
        return `
          <div class="info-box">
            <p><strong>NPCs:</strong> Crea un nuevo personaje no jugador.</p>
          </div>

          <div class="form-group">
            <label>ID del NPC (sin espacios, ej: merchant_john)</label>
            <input type="text" id="npcId" placeholder="merchant_john">
          </div>

          <div class="form-group">
            <label>Nombre del NPC</label>
            <input type="text" id="npcName" placeholder="John el Mercader">
          </div>

          <div class="form-group">
            <label>Descripci√≥n</label>
            <textarea id="npcDescription" rows="4" placeholder="Un mercader amigable con una gran sonrisa..."></textarea>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="app.goToStep(3)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" onclick="app.saveNPC()">‚úÖ Crear NPC</button>
          </div>
        `;
      },

      saveNPC() {
        const id = document.getElementById('npcId').value.trim();
        const name = document.getElementById('npcName').value.trim();
        const description = document.getElementById('npcDescription').value.trim();

        if (!id || !name || !description) {
          alert('Por favor completa todos los campos');
          return;
        }

        const data = this.data[this.currentLang][this.currentFile];
        if (!data[id]) data[id] = {};

        data[id].name = name;
        data[id].description = description;
        if (!data[id].dialogues) data[id].dialogues = {};

        this.saveToCache();
        alert(`‚úÖ NPC "${name}" creado correctamente`);
        this.goToStep(1);
      },

      getGenericForm() {
        return `
          <div class="info-box">
            <p>Formulario gen√©rico para este tipo de archivo.</p>
          </div>

          <div class="form-group">
            <label>ID/Clave</label>
            <input type="text" id="genericId" placeholder="mi_clave">
          </div>

          <div class="form-group">
            <label>Valor</label>
            <textarea id="genericValue" rows="4" placeholder="El valor de la traducci√≥n..."></textarea>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="app.goToStep(3)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" onclick="app.saveGeneric()">‚úÖ Guardar</button>
          </div>
        `;
      },

      saveGeneric() {
        const id = document.getElementById('genericId').value.trim();
        const value = document.getElementById('genericValue').value.trim();

        if (!id || !value) {
          alert('Por favor completa todos los campos');
          return;
        }

        const data = this.data[this.currentLang][this.currentFile];
        data[id] = value;

        this.saveToCache();
        alert(`‚úÖ Entrada "${id}" guardada correctamente`);
        this.goToStep(1);
      },

      showEditForm() {
        alert('Funci√≥n de edici√≥n en desarrollo');
        this.goToStep(3);
      },

      showDeleteForm() {
        alert('Funci√≥n de eliminaci√≥n en desarrollo');
        this.goToStep(3);
      },

      showNewLanguageModal() {
        const code = prompt('C√≥digo del idioma (2-3 letras, ej: fr, de, pt):');
        if (!code) return;

        const langCode = code.toLowerCase().trim();
        if (langCode.length < 2 || langCode.length > 3) {
          alert('El c√≥digo debe tener 2 o 3 letras');
          return;
        }

        if (this.data[langCode]) {
          alert('Este idioma ya existe');
          return;
        }

        this.data[langCode] = {
          commands: {},
          enemies: {},
          items: {},
          map: { islands: {} },
          messages: {},
          npcs: {},
          ui: {}
        };

        this.saveToCache();
        this.renderLanguageSelect();
        this.renderLanguageList();
        alert(`‚úÖ Idioma "${langCode.toUpperCase()}" creado correctamente`);
      },

      async exportAll() {
        if (!this.currentLang) {
          alert('Primero selecciona un idioma');
          return;
        }

        const zip = new JSZip();
        const langData = this.data[this.currentLang];
        const langFolder = zip.folder(this.currentLang);

        // A√±adir cada archivo JSON a la carpeta del idioma
        Object.entries(langData).forEach(([file, data]) => {
          const json = JSON.stringify(data, null, 2);
          langFolder.file(`${file}.json`, json);
        });

        // Generar el ZIP y descargarlo
        try {
          const content = await zip.generateAsync({ type: 'blob' });
          const url = URL.createObjectURL(content);
          const a = document.createElement('a');
          a.href = url;
          a.download = `i18n-${this.currentLang}.zip`;
          a.click();
          URL.revokeObjectURL(url);
          alert('‚úÖ Archivos exportados correctamente en ZIP');
        } catch (error) {
          console.error('Error al crear ZIP:', error);
          alert('‚ùå Error al crear el archivo ZIP');
        }
      }
    };

    // Init
    app.init();
  </script>
</body>
</html>
